@page "/edit/companyinfo/{CompanyId:int}"
@inject IDbContextFactory<VendorDataDbContext> ContextFactory;
@inject StateContainer StateContainer;
@inject NavigationManager NavigationManager


<div class="main">

    @if (Company == null)
    {
        <div class="mb-3">Loading...</div>
    }
    else
    {
        <h3>Edit/View Company @Company.Name</h3>


        @if (Account == null)
        {
            <div>Loading...</div>
        }
        else
        {
            <div class="create-account-container mb-4">
                <h3>Account:</h3>
                <AccountForm OnSubmit="@HandleAccountSubmit" IsEdit="true" Account="@Account" />
            </div>
        }

        <div class="create-account-container mb-4">
            <h3 class="mb-3">Company Info</h3>
            <CompanyInfoForm OnSubmit="@HandleCompanySubmit" IsEdit="true" Company="@Company" />
        </div>


        @if (Address == null)
        {
            <div>Loading...</div>
        }
        else
        {
            <div class="create-account-container mb-4">
                <h3 class="mb-3">Address</h3>
                <AddressForm OnSubmit="@HandleAddressSubmit" IsEdit="true" Address="@Address" />
            </div>
        }
    }

    <div class="panel company-panel mt-4">
        <div class="layout">
            <h2 class="company-header fs-4 fw-bold title">Companies/Vendors</h2>
            <p class="company-description desc">Manage companies that have registered</p>
        </div>
        <span class="building"><i alt="building icon" class="fa-solid fa-building fa-2x"></i></span>
        <a @onclick="@HandleNavigationCompanyList" class="stretched-link"></a>
    </div>

    <div class="panel home-panel mb-4 mt-4">
        <div class="layout">
            <h2 class="home-header fs-4 fw-bold title">Home Page</h2>
            <p class="home-description desc">Go back to home page to do various tasks</p>
        </div>
        <span class="house"><i alt="house icon" class="fa-solid fa-house fa-2x"></i></span>
        <a href="/" class="stretched-link"></a>
    </div>
</div>

@code {
    [Parameter]
    public int CompanyId { get; set; }

    private Company? Company { get; set; }
    private Account? Account { get; set; }
    private Address? Address { get; set; }
   


    protected override async Task OnParametersSetAsync()
    {
        using var context = ContextFactory.CreateDbContext();
        Company = await context.Companies.FirstOrDefaultAsync(comp => comp.Id == CompanyId);

        Account = await context.Accounts.FirstOrDefaultAsync(acc => acc.CompanyId == CompanyId);
        Address = await context.Addresses.FirstOrDefaultAsync(add => add.CompanyId == CompanyId);

    }

    private async Task HandleCompanySubmit(bool isValid)
    {
        if (Company is null || !isValid)
        {
            return;
        }
        using var context = ContextFactory.CreateDbContext();
        context.Update(Company);
        await context.SaveChangesAsync();
    }

    private async Task HandleAccountSubmit(bool isValid)
    {
        if (Account is null || !isValid)
        {
            return;
        }
        using var context = ContextFactory.CreateDbContext();
        context.Update(Account);
        await context.SaveChangesAsync();
    }

    private async Task HandleAddressSubmit(bool isValid)
    {
        if (Address is null || !isValid)
        {
            return;
        }
        using var context = ContextFactory.CreateDbContext();
        context.Update(Address);
        await context.SaveChangesAsync();
    }

    private void HandleNavigationCompanyList()
    {
        NavigationManager.NavigateTo($"/companies/{StateContainer.CompanyInfoPage}");
    }
}
